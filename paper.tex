%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[10pt, sigplan]{acmart}
%%\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,10pt,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[sigplan,10pt]{acmart}\settopmatter{}


%% Conference information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
%\acmConference[PL'17]{ACM SIGPLAN Conference on Programming Languages}{January 01--03, 2017}{New York, NY, USA}
%\acmYear{2017}
%\acmISBN{} % \acmISBN{978-x-xxxx-xxxx-x/YY/MM}
%\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
%\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2017}           %% If different from \acmYear

%% Bibliography style
%%\bibliographystyle{ACM-Reference-Format}
%% Citation style
%\citestyle{acmauthoryear}  %% For author/year citations
%\citestyle{acmnumeric}     %% For numeric citations
%\setcitestyle{nosort}      %% With 'acmnumeric', to disable automatic
                            %% sorting of references within a single citation;
                            %% e.g., \cite{Smith99,Carpenter05,Baker12}
                            %% rendered as [14,5,2] rather than [2,5,14].
%\setcitesyle{nocompress}   %% With 'acmnumeric', to disable automatic
                            %% compression of sequential references within a
                            %% single citation;
                            %% e.g., \cite{Baker12,Baker14,Baker16}
                            %% rendered as [2,3,4] rather than [2-4].


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from traditional SIGPLAN
%% proceedings format to PACMPL format must update the
%% '\documentclass' and topmatter commands above; see
%% 'acmart-pacmpl-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{ifthen}
%\input{macros.tex}

\usepackage{xcolor}
\newcommand{\sd}[1]{\color{red}\fbox{\bfseries\sffamily\scriptsize Stef:}{\sf\small$\blacktriangleright$\textit{#1}$\blacktriangleleft$}\color{black}}
\newcommand{\sk}[1]{\color{blue}\fbox{\bfseries\sffamily\scriptsize Sophie:}{\sf\small$\blacktriangleright$\textit{#1}$\blacktriangleleft$}\color{black}}
\newcommand{\cba}[1]{\color{purple}\fbox{\bfseries\sffamily\scriptsize Clement:}{\sf\small$\blacktriangleright$\textit{#1}$\blacktriangleleft$}\color{black}}


\begin{document}

%% Title information
\title[Short Title]{Assessing primitives performance\\ on multi-stage execution}       

%% Author with single affiliation.
\author{Sophie Kaleba}
                                        %% can be repeated if necessary
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{Cl\'ement B\'era}
\affiliation{
  % \position{}
	\department{Software Languages Lab}              %% \department is recommended
	\institution{Vrije Universiteit Brussel}            %% \institution is required
	\city{Brussel}
  % \state{}
  % \postcode{}
	\country{Belgium}                    %% \country is recommended
}
\email{clement.bera@vub.ac.be}          %% \email is recommended

%% Author with two affiliations and emails.
\author{St\'ephane Ducasse}
\affiliation{
 % \position{Position2b}
  \department{RMoD}             %% \department is recommended
  \institution{Inria}           %% \institution is required
  %\streetaddress{Street3b Address2b}
  \city{Lille}
  %\state{State2b}
  %\postcode{Post-Code2b}
  \country{France}                   %% \country is recommended
}
\email{stephane.ducasse@inria.fr}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}

Most of programming managed languages use primitive functions to speed up their execution time; these primitives usually implement core operations (such as addition, subtraction,...) or frequently used operations.
\cba{Le papier est sur les primitives d'optimisations, pas sur les primitives essentielles. Je parlerais que des prims d'optimisations dans l'abstract et expliquerais la difference dans l'intro.}
They are also massively used in the context of dynamic or just-in-time compilation: the compiler then executes this alternative version instead of the standard one to gain performance.
\cba{Il y a des problemes de terminologie. Le JIT compile, n'exécute rien. La VM exécute le code. A l'oral, par abus de langage, on peut dire le JIT execute, mais dans un papier il faut etre rigoureux}
%%Problem

\textbf{One of the challenge is that dynamic compilation is slower then static compilation}:
\cba{Ce que j'ai mis en gras, je le vois en tant que reviewer de manière aussi directe, je met strong reject et je quote la phrase dans la review. Je suis un des reviewers les plus sympas d'ICOOOLPS, les autres seront plus aggressifs que ca.}
 in this context, one has to set up strategies to reach higher performance. In particular since execution may require crossing borders of different paradigms (assembly, C calls,...) with their associated costs. Once such strategies are understood and accessed, primitives can thus be implemented in the context of just in time compilation.
 \cba{Je comprend pas ce que tu veux dire}
 
 \cba{Je me demande si c'est pas trop verbeux jusque là. Ecrire des phrases introduisant: (1) Managed runtime, (2) primitive d'optimisation, (3) la possibilité de l'implem dans le language bas niveau où est implémenté la VM comme C/C++ ou dans une representation intermédiaire du JIT. (4) les avantages / problèmes des 2 approches me parait mieux}

%%\item Aim \\
This paper describes and compares the recent implementation of optimised versions of the String comparison primitive \textit{at different stages of the code execution} and their impact on execution time.
\cba{peut etre enleve ça, l'essentiel c'est ce qui est écrit avant}
\cba{Introduit clairement a quoi corresponde chaque implem, C external lib, C internal code, back-end de JIT, etc.}
 This analysis is performed on the opensmalltalk virtual machine (known as Cog) that dynamically compiles oriented-object languages such as Newspeak, Pharo and Squeak.
 \cba{Verbeux, a fusionner avec une phrase sur les resultats. Peut etre mettre une phrase comme quoi ca pourrait s'appliquer a d'autres MV avec runtime LLevel C/C++ typiquement + JIT vers code natif}
%%\item Perspectives \\
[describes briefly the 3 implementations and compares with V8 and Java?]\\
\cba{Personnellement je ne parlerais pas des related work dans l'abstract dans ce papier car la direction principale n'est pas une comparaison avec un related work. A la place je finirais l'abstract par une phrase sur les résultats en parlant du trade-off, genre dans la back-end du JIT la vitesse d'execution est plus fiable (pas de pb avec les differences de compil LLVM/GCC par ex), est rapide, mais par contre le cout d'ingenierie est supérieur. Il faut donc mesure l'utilisation de chaque primitive de performance et mettre un place un ratio complexité/performance }

\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
%\begin{CCSXML}
%<ccs2012>
%<concept>
%<concept_id>10011007.10011006.10011008</concept_id>
%<concept_desc>Software and its engineering~General programming languages</concept_desc>
%<concept_significance>500</concept_significance>
%</concept>
%<concept>
%<concept_id>10003456.10003457.10003521.10003525</concept_id>
%<concept_desc>Social and professional topics~History of programming languages</concept_desc>
%<concept_significance>300</concept_significance>
%</concept>
%</ccs2012>
%\end{CCSXML}

%\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{Just-in-Time compiler, Primitive, Virtual machine, Managed runtime}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}

\cba{Ici il faut répéter l'abstract en detaillant plus chaque chose.
Comme le coeur du papier est sur String prim, tu introduis la primitive sur laquelle tu vas travailler, dont la representation des strings, ses cas d'utilisation
Il faut que tu précises bien le coût de changement entre la pile St et la pile C et que tu expliques le probleme des primitives C courtes appelées depuis le code généré par le JIT. Je ferais une figure. C'est important pour la suite. 
Il faut definir primitive, primitive essentielle, primitive d'optimisation. Il faut expliquer brievement les primitives Smalltalk, comment elles sont activées, dans quelles cas le fall back code est appelé, que si elles fail c'est side-effect free. => Dans mon papier ISMM'15 il y a une explication section 4.2 le début de Primitive operations. dont tu peux t'inspirer, voir copier coller comme je suis auteur des 2.}

Short description of the String class (String, ByteString, WideString)?
\cba{oui, explique la primitive, dont la representation des strings, ses cas d'utilisation}

\section{Terminology}
\cba{Je mettrais section 2 "Implementations evaluated", tu ne definis par vraiment de terminology a part la premiere subsection que je bougerais en intro}

\cba{Les definitions de primitive d'optimisation et essentielles je les mettrais dans l'intro}
\subsection{definitions}
\begin{itemize}
	\item primitive (but already defined in abstract?) \cba{Dans le papier tu dois faire comme si l'abstract n'existait pas et tout redéfinir. Par contre tu peux définir dans l'intro}
	\item 
\end{itemize}


Understanding primitive implementation and execution

\cba{Je pense il faut comparer 
(1) Smalltalk pur (ta baseline, pas grand chose à discuter, tu peux exprimer les autres en relative speed-up par rapport a la baseline dans les graphes de resultats.)
(2) SmalltalkSmartSyntax + Misc
(3) SlangSmartSyntax + Misc, 
(4) Slang, 
(5) Cog's RTL
(6) eventuellement Cog's x86 back-end si tu veux faire une implem spécifique a x86 en plus avec SSE4.}
\cba{Dans les parties suivante tu définis chaque cas, tu évalues les perfs sur micro et macro benchmarks, tu discutes le code machine généré par les compilo C et le JIT, tu montres les boucles de comparaison ASM générées par les compilo C et le JIT et u mets l'intégralité des fonctions avec tous les codes sources et générés en appendices.}

\subsection{MiscPlugin}
Code compiled into bytecode and interpreted\\
trade-off 
\begin{itemize}
	\item +: easy to code, easy to read, implementation in-image, no need to recompile th vm sources in case of modification \cba{Ah bon, Y'a pas besoin de recompiler les sources en cas de modif VM? Ca sort d'ou ca? Le problème est que l'image VMMaker qui génère le code C de la VM utilise sa version de la primitive justement}
	\item -: slow
\end{itemize}

\subsection{primitive in Slang}
Slang is compiled to C (by usual c compilers gcc/llvm), and the resulting machine code is executed\\
trade-off
\begin{itemize}
	\item +: faster execution \cba{Pourquoi c'est plus rapide? Access to VM internal API, etc.}
	\item -: costly jumps between Smalltalk and C runtime (trampolines), need to recompile vm sources, little control over outcome (c compilers optimizations)
\end{itemize}

\subsection{primitive in baseline JIT}
generate functions as machine code
partial implementation (frequent cases are implemented)
Sometimes, fallback to less-optimised version\\

trade-off
\begin{itemize}
	\item +: faster (faster) execution (no c - Smalltalk runtime jumps), control over the outcome
	\item -: need to recompile vm sources (trampolines), code readability 
\end{itemize}

\subsection{primitive in optimizing JIT}


add appendix with code


\cba{Future work -> primitive processor dependent (i.e. SSE4 instrs), pros and cons and why you did not do it (ingeniering cost per back-end)}

\section{Assessment}
All these versions of the primitives have been implemented. Compare performances

\subsection{Micro-benchmarks}
Results on strings of different lengths (3, 10, 1000)

\subsection{Macro-benchmarks}
JSON
PetitParser
XML


\section{Related work}

\begin{itemize}
	\item Java: platform dependent
	\item V8: interpreter compiled by JIT
	optimised backend
	as if we were compiling slang using the JIT compiler (ahead of time)
	no more virtual call
	\item VisualWorks: baseline JIT but no interpreter
\end{itemize}

\cba{Ajoute le related work que tu as trouvé de ICOOOLPS avec le travail de Tim.}

\section{Future work and conclusion}
1. number of representations\\
2. common representation

\cba{Ici tu mets 
(6) eventuellement Cog's x86 back-end si tu veux faire une implem spécifique a x86 en plus avec SSE4.
si tu l'as pas mis avant}

%% Acknowledgments
%%\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
%  This material is based upon work supported by the
%  \grantsponsor{GS100000001}{National Science
%    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
%  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
%  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
%  conclusions or recommendations expressed in this material are those
%  of the author and do not necessarily reflect the views of the
%  National Science Foundation.
%\end{acks}


%% Bibliography
%\bibliography{bibfile}


%% Appendix
\appendix
\section{Appendix}

\cba{Source code et generated C and ASM code for all versions}

Text of appendix \ldots

\end{document}
